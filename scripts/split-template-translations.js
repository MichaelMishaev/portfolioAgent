#!/usr/bin/env node

/**
 * Migration Script: Split template-translations.json into individual files
 *
 * This script splits the monolithic 668KB template-translations.json file
 * into 61 separate files (one per template) for better performance and maintainability.
 *
 * Output structure:
 * lib/translations/templates/
 *   minimalist.json
 *   bold-typography.json
 *   ... (61 files total)
 *
 * Each file contains:
 * {
 *   "en": { ... },
 *   "ru": { ... },
 *   "he": { ... }
 * }
 */

const fs = require('fs');
const path = require('path');

// Paths
const SOURCE_FILE = path.join(__dirname, '../lib/template-translations.json');
const OUTPUT_DIR = path.join(__dirname, '../lib/translations/templates');
const BACKUP_FILE = path.join(__dirname, '../lib/template-translations.json.backup');

console.log('üöÄ Starting template translations migration...\n');

// Step 1: Read source file
console.log('üìñ Reading source file:', SOURCE_FILE);
const sourceData = JSON.parse(fs.readFileSync(SOURCE_FILE, 'utf8'));

// Step 2: Create backup
console.log('üíæ Creating backup:', BACKUP_FILE);
fs.copyFileSync(SOURCE_FILE, BACKUP_FILE);

// Step 3: Create output directory
console.log('üìÅ Creating output directory:', OUTPUT_DIR);
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

// Step 4: Extract template IDs (all keys except 'common')
const languages = ['en', 'ru', 'he'];
const templateIds = new Set();

languages.forEach(lang => {
  if (sourceData[lang]) {
    Object.keys(sourceData[lang]).forEach(key => {
      if (key !== 'common') {
        templateIds.add(key);
      }
    });
  }
});

const templateIdsArray = Array.from(templateIds).sort();
console.log(`\nüìä Found ${templateIdsArray.length} templates to split:\n`);

// Step 5: Create individual files
let successCount = 0;
let errorCount = 0;

templateIdsArray.forEach((templateId, index) => {
  const outputFile = path.join(OUTPUT_DIR, `${templateId}.json`);

  try {
    // Extract translations for this template from all languages
    const templateData = {};

    languages.forEach(lang => {
      if (sourceData[lang] && sourceData[lang][templateId]) {
        templateData[lang] = sourceData[lang][templateId];
      }
    });

    // Write to file with pretty formatting
    fs.writeFileSync(
      outputFile,
      JSON.stringify(templateData, null, 2),
      'utf8'
    );

    // Calculate file size
    const stats = fs.statSync(outputFile);
    const sizeKB = (stats.size / 1024).toFixed(1);

    console.log(`  ${index + 1}. ‚úÖ ${templateId}.json (${sizeKB} KB)`);
    successCount++;
  } catch (error) {
    console.log(`  ${index + 1}. ‚ùå ${templateId}.json - Error: ${error.message}`);
    errorCount++;
  }
});

// Step 6: Create a common.json file for shared translations
console.log('\nüìù Creating common.json for shared translations...');
const commonData = {};
languages.forEach(lang => {
  if (sourceData[lang] && sourceData[lang].common) {
    commonData[lang] = sourceData[lang].common;
  }
});

const commonFile = path.join(OUTPUT_DIR, 'common.json');
fs.writeFileSync(
  commonFile,
  JSON.stringify(commonData, null, 2),
  'utf8'
);
console.log('  ‚úÖ common.json created');

// Step 7: Generate index file for easy imports
console.log('\nüìù Creating index.ts for type safety...');
const indexContent = `/**
 * Template Translations Index
 * Auto-generated by split-template-translations.js
 *
 * Usage:
 * import { getTemplateTranslations } from '@/lib/translations/templates';
 * const translations = await getTemplateTranslations('minimalist', 'en');
 */

export type Language = 'en' | 'ru' | 'he';

export interface TemplateTranslations {
  en: Record<string, any>;
  ru: Record<string, any>;
  he: Record<string, any>;
}

/**
 * Load translations for a specific template and language
 * This uses dynamic imports for code splitting
 */
export async function getTemplateTranslations(
  templateId: string,
  language?: Language
): Promise<any> {
  try {
    const translations: TemplateTranslations = await import(\`./\${templateId}.json\`);

    // If language specified, return only that language
    if (language) {
      return translations[language] || translations.en;
    }

    // Otherwise return all languages
    return translations;
  } catch (error) {
    console.error(\`Failed to load translations for template: \${templateId}\`, error);
    // Fallback to empty object
    return language ? {} : { en: {}, ru: {}, he: {} };
  }
}

/**
 * Load common translations (used across all templates)
 */
export async function getCommonTranslations(language?: Language): Promise<any> {
  try {
    const translations: TemplateTranslations = await import('./common.json');
    return language ? translations[language] : translations;
  } catch (error) {
    console.error('Failed to load common translations', error);
    return language ? {} : { en: {}, ru: {}, he: {} };
  }
}

/**
 * Available template IDs
 */
export const TEMPLATE_IDS = ${JSON.stringify(templateIdsArray, null, 2)} as const;

export type TemplateId = typeof TEMPLATE_IDS[number];
`;

const indexFile = path.join(OUTPUT_DIR, 'index.ts');
fs.writeFileSync(indexFile, indexContent, 'utf8');
console.log('  ‚úÖ index.ts created');

// Summary
console.log('\n' + '='.repeat(60));
console.log('‚ú® Migration Complete!\n');
console.log(`üìä Summary:`);
console.log(`  - Templates processed: ${templateIdsArray.length}`);
console.log(`  - Successful: ${successCount}`);
console.log(`  - Errors: ${errorCount}`);
console.log(`  - Output directory: ${OUTPUT_DIR}`);
console.log(`  - Backup created: ${BACKUP_FILE}`);

// Calculate size reduction
const sourceStats = fs.statSync(SOURCE_FILE);
const sourceSizeKB = (sourceStats.size / 1024).toFixed(1);
console.log(`\nüìâ Size Reduction:`);
console.log(`  - Original file: ${sourceSizeKB} KB`);
console.log(`  - Average per template: ~${(sourceSizeKB / templateIdsArray.length).toFixed(1)} KB`);
console.log(`  - Estimated savings: ~${((1 - 1/templateIdsArray.length) * 100).toFixed(1)}% per page load`);

console.log('\n‚úÖ Next steps:');
console.log('  1. Run: npm run build (to test the new structure)');
console.log('  2. Update i18n-context.tsx to use new loaders');
console.log('  3. Update template pages to use server-side loading');
console.log('  4. Test a few templates');
console.log('  5. Delete backup file once confirmed working');
console.log('='.repeat(60));
