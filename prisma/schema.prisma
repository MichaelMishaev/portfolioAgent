// Prisma Schema for Discount System
// Generated for DaNuNa Portfolio Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// DISCOUNT SYSTEM MODELS
// ============================================

model DiscountCode {
  id                String   @id @default(cuid())

  // Code Identifier
  code              String   @unique @db.VarChar(50)
  description       String?  @db.VarChar(500)
  internalNotes     String?  @db.Text  // Admin-only notes

  // Discount Configuration
  discountType      DiscountType
  discountValue     Float    // Percentage (0-100) or Fixed amount

  // Usage Limits
  maxUses           Int?     // null = unlimited
  currentUses       Int      @default(0)
  maxUsesPerUser    Int      @default(1)  // Default: one per user

  // Time Constraints
  validFrom         DateTime @default(now())
  validUntil        DateTime?
  timezone          String   @default("UTC") @db.VarChar(50)

  // Purchase Restrictions
  minPurchaseAmount Float?   // Minimum cart value
  maxDiscountAmount Float?   // Cap the discount (e.g., max $100 off)

  // Template Restrictions
  templateIds       String[] // Empty array = applies to all
  categoryIds       String[] // Empty array = applies to all categories
  excludedTemplateIds String[] // Blacklist specific templates

  // Combination Rules
  canStackWithOthers Boolean @default(false)
  priority          Int     @default(0)  // Higher priority applied first

  // Status & Metadata
  isActive          Boolean  @default(true)
  isPublic          Boolean  @default(true)  // False = admin-only/private

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?  // Admin user ID
  updatedBy         String?
  deactivatedAt     DateTime?
  deactivatedBy     String?
  deactivationReason String?

  // Analytics Tracking
  totalRevenue      Float    @default(0)  // Denormalized for performance
  totalDiscountGiven Float   @default(0)  // Denormalized
  conversionRate    Float?   // Calculated periodically

  // Relations
  usages            DiscountUsage[]
  auditLogs         DiscountAuditLog[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
  @@index([createdBy])
  @@map("discount_codes")
}

enum DiscountType {
  PERCENTAGE  // e.g., 20% off
  FIXED       // e.g., $50 off

  @@map("discount_type")
}

model DiscountUsage {
  id                String   @id @default(cuid())

  // Relationships
  discountCode      DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  codeId            String

  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?

  purchase          Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId        String   @unique

  // Usage Status
  status            UsageStatus @default(RESERVED)

  // Reservation System
  reservedAt        DateTime @default(now())
  expiresAt         DateTime  // reservedAt + 15 minutes
  confirmedAt       DateTime?
  releasedAt        DateTime?

  // Financial Details
  originalAmount    Float    // Cart total before discount
  discountAmount    Float    // Actual $ saved
  finalAmount       Float    // Final amount charged
  taxAmount         Float?   // Tax calculated on final amount

  // Applied Rules (snapshot at time of use)
  discountSnapshot  Json     // Full discount code config at time of use

  // Fraud Prevention
  ipAddress         String?  @db.VarChar(45)  // IPv4 or IPv6
  userAgent         String?  @db.Text
  deviceFingerprint String?  @db.VarChar(255)
  geoCountry        String?  @db.VarChar(2)   // ISO country code
  geoCity           String?  @db.VarChar(100)

  // Risk Scoring (fraud detection)
  riskScore         Float?   @default(0)      // 0-100
  riskFactors       String[] // e.g., ["VPN", "DISPOSABLE_EMAIL"]
  isManuallyReviewed Boolean @default(false)
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([codeId, userId])
  @@index([status, expiresAt])
  @@index([userId])
  @@index([purchaseId])
  @@index([reservedAt])
  @@unique([codeId, userId, status], name: "one_active_usage_per_user")
  @@map("discount_usages")
}

enum UsageStatus {
  RESERVED    // Slot reserved during checkout
  CONFIRMED   // Payment successful
  RELEASED    // Released due to timeout/failure
  REFUNDED    // Purchase was refunded

  @@map("usage_status")
}

model DiscountAuditLog {
  id              String   @id @default(cuid())

  // Relationship
  discountCode    DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  codeId          String

  // Action Details
  action          AuditAction
  performedBy     String?  // User ID (null = system)
  performedByType String   @default("USER") // USER, ADMIN, SYSTEM, CRON

  // Change Tracking
  changesBefore   Json?    // State before change
  changesAfter    Json?    // State after change

  // Context
  reason          String?  @db.Text
  ipAddress       String?  @db.VarChar(45)
  userAgent       String?  @db.Text

  // Metadata
  createdAt       DateTime @default(now())

  @@index([codeId, createdAt])
  @@index([performedBy])
  @@map("discount_audit_logs")
}

enum AuditAction {
  CREATED
  UPDATED
  ACTIVATED
  DEACTIVATED
  DELETED
  USAGE_INCREMENTED
  USAGE_DECREMENTED
  MANUAL_ADJUSTMENT
  EXPIRED

  @@map("audit_action")
}

// ============================================
// PURCHASE SYSTEM MODELS
// ============================================

model Purchase {
  id                String   @id @default(cuid())

  // User Relationship
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?

  // Purchase Details
  templateId        String
  template          Template @relation(fields: [templateId], references: [id])

  // Pricing
  basePrice         Float    // Original template price
  finalPrice        Float    // Final charged amount (after discount)
  currency          String   @default("USD") @db.VarChar(3)

  // Status
  status            PurchaseStatus @default(PENDING)

  // Discount
  discountUsage     DiscountUsage?

  // Payment Provider
  stripePaymentIntentId String? @unique
  stripeCustomerId      String?
  stripeInvoiceId       String?

  // Payment Metadata
  paymentMethod     String?  // card, paypal, etc.
  last4             String?  @db.VarChar(4)
  cardBrand         String?  @db.VarChar(20)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?
  failedAt          DateTime?
  refundedAt        DateTime?

  // Refund Info
  refundReason      String?  @db.Text
  refundAmount      Float?
  partialRefund     Boolean  @default(false)

  // License & Delivery
  licenseKey        String?  @unique @db.VarChar(100)
  downloadUrl       String?  @db.Text
  downloadCount     Int      @default(0)
  downloadExpiresAt DateTime?

  // Customer Info (snapshot for invoices)
  customerEmail     String   @db.VarChar(255)
  customerName      String?  @db.VarChar(255)
  billingAddress    Json?

  // Metadata
  metadata          Json?    // Additional data

  @@index([userId, status])
  @@index([templateId])
  @@index([status, createdAt])
  @@index([stripePaymentIntentId])
  @@map("purchases")
}

enum PurchaseStatus {
  PENDING           // Checkout initiated
  PROCESSING        // Payment being processed
  COMPLETED         // Payment successful
  FAILED            // Payment failed
  REFUNDED          // Full refund
  PARTIALLY_REFUNDED // Partial refund
  ABANDONED         // Cart abandoned (timeout)
  DISPUTED          // Chargeback/dispute

  @@map("purchase_status")
}

// ============================================
// USER & TEMPLATE MODELS
// ============================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique @db.VarChar(255)
  name              String?  @db.VarChar(255)

  // Account Status
  isActive          Boolean  @default(true)
  isBanned          Boolean  @default(false)
  bannedReason      String?  @db.Text
  bannedAt          DateTime?

  // Role
  role              UserRole @default(CUSTOMER)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastLoginAt       DateTime?

  // Relations
  purchases         Purchase[]
  discountUsages    DiscountUsage[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN

  @@map("user_role")
}

model Template {
  id                String   @id @default(cuid())
  name              String   @db.VarChar(255)
  slug              String   @unique @db.VarChar(255)

  // Pricing
  price             Float
  currency          String   @default("USD") @db.VarChar(3)

  // Category
  categoryId        String?

  // Status
  isActive          Boolean  @default(true)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  purchases         Purchase[]

  @@index([slug])
  @@index([categoryId])
  @@map("templates")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model DiscountAnalytics {
  id                String   @id @default(cuid())

  // Time Period
  date              DateTime @db.Date
  codeId            String?  // null = all codes aggregate

  // Metrics
  impressions       Int      @default(0)  // Code viewed
  attempts          Int      @default(0)  // Code attempted
  successes         Int      @default(0)  // Code successfully applied
  failures          Int      @default(0)  // Code validation failed

  // Financial
  totalRevenue      Float    @default(0)
  totalDiscounts    Float    @default(0)
  avgOrderValue     Float?

  // Conversion
  conversionRate    Float?   // successes / attempts

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([date, codeId])
  @@index([date])
  @@index([codeId])
  @@map("discount_analytics")
}
